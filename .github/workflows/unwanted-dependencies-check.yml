name: unwanted-dependencies-check

# Trigger the workflow on pull requests and direct pushes to any branch
on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  conditional-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      doc: ${{ steps.filter.outputs.doc }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          doc:
            - 'site/**'

  unwanted-dependency-check:
      name: Run unwanted dependencies check
      runs-on: ubuntu-latest
      needs: conditional-changes
      # Ignore docs changes, and only apply for pull requests from different repository 
      if: (needs.conditional-changes.outputs.doc == 'false' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository)
      steps:
        - name: Clone the code
          uses: actions/checkout@v4
          with:
              fetch-depth: 0
        - name: Setup Go
          uses: actions/setup-go@v5
          with:
              go-version-file: go.work
        - name: 'Setup jq'
          uses: dcarbone/install-jq-action@v2
          with:
              version: '1.7'
              force: 'true'
        - name: Run script
          run: |
              sudo apt-get update
              sudo apt-get install wget -y
              ./hack/unwanted-dependencies-check.sh
        - name: Report failure
          uses: nashmaniac/create-issue-action@v1.2
          # Only report failures of pushes (PRs have are visible through the Checks section) to the default branch
          if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/master'
          with:
              title: ðŸ“¦ unwanted-dependencies-check failed for ${{ github.sha }}
              token: ${{ secrets.GITHUB_TOKEN }}
              labels: kind/dependencies
              body: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
  